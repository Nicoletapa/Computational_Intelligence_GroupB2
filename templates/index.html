<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flight Network Disruption Simulator 3D</title>
  <script src="//unpkg.com/globe.gl"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; overflow: hidden; background: #000; }
    
    #container { display: flex; height: 100vh; position: relative; }
    
    /* 3D Container */
    #globe-viz { flex: 1; height: 100%; background: #040d21; } /* Dark Space Blue */

    /* Sidebar (Kept identical) */
    #sidebar { width: 380px; background: #ffffff; color: #2c3e50; overflow-y: auto; z-index: 10; box-shadow: 4px 0 10px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
    #sidebar::-webkit-scrollbar { width: 8px; }
    #sidebar::-webkit-scrollbar-track { background: #f5f7fa; }
    #sidebar::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
    
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; color: white; }
    .header h1 { font-size: 24px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
    .section { padding: 20px 24px; border-bottom: 1px solid #e2e8f0; }
    .section h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; color: #667eea; }
    
    .control-group { margin-bottom: 16px; }
    .control-group label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 8px; color: #4a5568; }
    .input-row { display: flex; gap: 8px; align-items: center; }
    input[type="number"], select { flex: 1; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
    
    .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; flex: 1; }
    .btn-secondary { background: #e2e8f0; color: #4a5568; flex: 1; }
    .button-row { display: flex; gap: 12px; }

    .metrics-box { background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-top: 8px; }
    .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .metric-card { background: #ffffff; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; }
    .metric-label { font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 4px; }
    .metric-value { font-size: 20px; font-weight: 700; color: #667eea; }
    .metric-change.negative { color: #e53e3e; }

    .community-legend { background: rgba(255, 255, 255, 0.95); padding: 12px; border-radius: 8px; font-size: 11px; border: 1px solid #e2e8f0; margin-top: 8px; }
    .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .legend-color-box { width: 16px; height: 16px; border-radius: 3px; }
    
    #airport-list { max-height: 400px; overflow-y: auto; }
    .airport-item { padding: 12px; margin-bottom: 6px; background: #f7fafc; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .airport-item:hover { background: #edf2f7; transform: translateX(4px); }
    .airport-item.disrupted { background: #fff5f5; border: 1px solid #fc8181; }
    .airport-code { font-weight: 700; font-size: 14px; min-width: 40px; }
    .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .status-badge.active { background: #c6f6d5; color: #22543d; }
    .status-badge.disrupted { background: #fed7d7; color: #742a2a; }

    .loading { display: none; text-align: center; padding: 20px; color: #667eea; }
    .loading.active { display: block; }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <div class="header">
        <h1><i class="fas fa-globe-americas"></i> Network Disruption</h1>
        <p>Global Resilience Simulator</p>
      </div>

      <div class="section">
        <h3><i class="fas fa-sliders-h"></i> Controls</h3>
        <div class="control-group">
          <label>Auto-disrupt top airports</label>
          <div class="input-row">
            <input id="auto_n" type="number" value="0" min="0" max="50" placeholder="0">
            <select id="centrality">
              <option value="betweenness">Betweenness</option>
              <option value="degree">Degree</option>
              <option value="closeness">Closeness</option>
            </select>
          </div>
        </div>
        <div class="button-row">
          <button id="simulate" class="btn btn-primary"><i class="fas fa-play"></i> Simulate</button>
          <button id="reset" class="btn btn-secondary"><i class="fas fa-redo"></i> Reset</button>
        </div>
      </div>

      <div class="section">
        <h3><i class="fas fa-chart-line"></i> Metrics</h3>
        <div class="loading" id="loading">Analyzing...</div>
        <div class="metrics-box" id="metrics">
          <div style="text-align: center; color: #718096; padding: 20px;">Click <strong>Simulate</strong></div>
        </div>
        <div class="community-legend" id="community-legend" style="display: none;">
          <div id="legend-content"></div>
        </div>
      </div>

      <div class="section" style="flex: 1;">
        <h3><i class="fas fa-list"></i> Airports</h3>
        <div id="airport-list"></div>
      </div>
    </div>

    <!-- 3D Globe Container -->
    <div id="globe-viz"></div>
  </div>

  <script>
    const COLORS = {
      active: '#48bb78',
      disrupted: '#ef4444',
      stranded: '#f97316',
      strandedAirport: '#fb923c'
    };

    // Adjusted Palette for visibility against Blue Earth
    const PALETTE = [
      '#d90429', '#7209b7', '#3a0ca3', '#4361ee', 
      '#f72585', '#007f5f', '#ffb703', '#fb8500', 
      '#89c2d9', '#9b2226', '#6d6875', '#2b9348'
    ];

    function getGroupColor(groupId) {
      if (groupId === -1) return 'rgba(50,50,50, 0.3)'; // Grey/Transparent for bridges
      return PALETTE[groupId % PALETTE.length];
    }

    const airportsGeo = {{ airports_json | safe }};
    const routesGeo = {{ routes_json | safe }};
    
    const disruptedSet = new Set();
    const strandedSet = new Set();
    let currentAirportsGeo = airportsGeo;
    let currentRoutesGeo = routesGeo;
    let communityCount = 0;
    let countriesData = [];

    // ========== OPTIMIZED GLOBE INITIALIZATION ==========
    const globe = Globe()
      // 1. VISUALS: REALISTIC EARTH
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg') 
      .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
      .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
      .showAtmosphere(true) // Glow effect
      .atmosphereColor('#3a228a')
      .atmosphereAltitude(0.15)
      
      .width(document.getElementById('globe-viz').clientWidth)
      .height(window.innerHeight)
      
      // 2. POINTS (Airports)
      .pointLat('lat')
      .pointLng('lng')
      .pointColor('color')
      .pointAltitude('altitude')
      .pointRadius('radius')
      .pointsMerge(true) 
      .onPointClick(d => toggleAirport(d.code))
      .pointLabel(d => `<div style="background:rgba(0,0,0,0.8);color:white;padding:4px 8px;border-radius:4px;"><b>${d.code}</b>: ${d.city}</div>`)

      // 3. ARCS (Routes)
      .arcStartLat('startLat')
      .arcStartLng('startLng')
      .arcEndLat('endLat')
      .arcEndLng('endLng')
      .arcColor('color')
      .arcDashLength('dash')
      .arcDashGap('gap')
      .arcDashAnimateTime('animate')
      .arcAltitude('arcAlt')
      .arcStroke('stroke') // Control thickness
      
      // 4. POLYGONS (Countries)
      .polygonSideColor(() => 'rgba(0,0,0,0)')
      .polygonStrokeColor(() => 'rgba(255,255,255,0.1)')
      .polygonCapColor(d => d.color)
      .polygonAltitude(0.008) // Very flat to avoid z-fighting
      .onPolygonClick(d => toggleCountry(d.properties.name))
      .polygonLabel(d => `<div style="background:black;color:white;padding:4px;">${d.properties.name}</div>`)
      
      (document.getElementById('globe-viz'));

    globe.controls().autoRotate = false;
    globe.controls().autoRotateSpeed = 0.3;
    globe.controls().enableZoom = true;

    window.addEventListener('resize', () => {
      globe.width(document.getElementById('globe-viz').clientWidth);
      globe.height(window.innerHeight);
    });

    function updateGlobeLayers() {
      
      // --- Points (Optimized) ---
      const pointsData = currentAirportsGeo.features.map(f => {
        const p = f.properties;
        let color = getGroupColor(p.group);
        let radius = 0.15; // Smaller
        let alt = 0.01;

        if (p.disrupted) {
          color = COLORS.disrupted;
          radius = 0.3;
          alt = 0.05;
        } else if (strandedSet.has(p.code)) {
          color = COLORS.strandedAirport;
          radius = 0.25;
        }
        return {
          code: p.code, city: p.city, lat: f.geometry.coordinates[1], lng: f.geometry.coordinates[0],
          color: color, radius: radius, altitude: alt, group: p.group
        };
      });

      // --- Routes (Performance Fix Here) ---
      const arcsData = [];
      const coordsMap = {};
      pointsData.forEach(p => coordsMap[p.code] = { lat: p.lat, lng: p.lng });

      currentRoutesGeo.features.forEach(f => {
        const p = f.properties;
        const src = coordsMap[p.src];
        const dst = coordsMap[p.dst];
        if (!src || !dst) return;

        const disrupted = p.disrupted;
        const isStranded = strandedSet.has(p.src) || strandedSet.has(p.dst);
        const groupId = p.group;

        let color, stroke, dash, gap, animate, arcAlt;

        if (disrupted) {
          color = ['rgba(239, 68, 68, 0.8)', 'rgba(239, 68, 68, 0.8)'];
          stroke = 0.15; // Thin
          dash = 0.5;    // Small dashes
          gap = 1;
          animate = null; // NO ANIMATION (Performance)
          arcAlt = 0.02;  // Flat
        } else if (isStranded) {
          color = [COLORS.stranded, COLORS.stranded];
          stroke = 0.2;
          dash = null; gap = null;
          animate = 2000; // Animate ONLY stranded for visual pop
          arcAlt = 0.15;
        } else {
          // Active Routes
          const c = getGroupColor(groupId);
          // NOTE: We use 'null' for animate to make lines STATIC. 
          // This saves huge CPU resources.
          animate = null; 
          stroke = 0.12; // Very Thin
          dash = null; gap = null;
          
          if (groupId === -1) {
            // Bridges
            color = ['rgba(50,50,50,0.1)', 'rgba(50,50,50,0.1)'];
            arcAlt = 0.35;
          } else {
            // Standard
            color = [c, c];
            arcAlt = 0.15;
          }
        }

        arcsData.push({
          startLat: src.lat, startLng: src.lng, endLat: dst.lat, endLng: dst.lng,
          color: color, stroke: stroke, dash: dash, gap: gap, animate: animate, arcAlt: arcAlt
        });
      });

      globe.pointsData(pointsData);
      globe.arcsData(arcsData);
      updateCountryColors();
    }

    // Logic (Same as before)
    const countryToAirports = {};
    airportsGeo.features.forEach(f => {
      const c = f.properties.country;
      if (!countryToAirports[c]) countryToAirports[c] = [];
      countryToAirports[c].push(f.properties.code);
    });

    fetch('//unpkg.com/world-atlas/countries-110m.json').then(res => res.json()).then(data => {
        countriesData = topojson.feature(data, data.objects.countries).features;
        globe.polygonsData(countriesData);
        updateCountryColors();
    });

    function updateCountryColors() {
      if (!countriesData.length) return;
      globe.polygonCapColor(d => {
        let airports = countryToAirports[d.properties.name];
        if (!airports) {
           const key = Object.keys(countryToAirports).find(k => k.includes(d.properties.name) || d.properties.name.includes(k));
           if(key) airports = countryToAirports[key];
        }
        if (!airports) return 'rgba(0,0,0,0)';
        const dc = airports.filter(c => disruptedSet.has(c)).length;
        if (airports.length > 0 && dc === airports.length) return 'rgba(239, 68, 68, 0.5)'; // Red
        if (dc > 0) return 'rgba(249, 115, 22, 0.4)'; // Orange
        return 'rgba(0,0,0,0)'; // Transparent for active
      });
    }

    function toggleCountry(cName) {
      let airports = countryToAirports[cName];
       if (!airports) {
           const key = Object.keys(countryToAirports).find(k => k.includes(cName) || cName.includes(k));
           if(key) airports = countryToAirports[key];
        }
      if(!airports) return;
      const all = airports.every(c => disruptedSet.has(c));
      airports.forEach(c => all ? disruptedSet.delete(c) : disruptedSet.add(c));
      updateGlobeLayers(); renderAirportList();
    }

    function toggleAirport(code) {
      if (disruptedSet.has(code)) disruptedSet.delete(code);
      else disruptedSet.add(code);
      updateGlobeLayers(); renderAirportList();
    }

    const simulate = async () => {
      const autoN = parseInt(document.getElementById('auto_n').value) || 0;
      document.getElementById('loading').classList.add('active');
      document.getElementById('metrics').style.display = 'none';
      try {
        const res = await fetch('/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            disrupted: Array.from(disruptedSet),
            auto_top_n: autoN,
            centrality_metric: document.getElementById('centrality').value
          })
        });
        const data = await res.json();
        disruptedSet.clear(); strandedSet.clear();
        data.disrupted_list.forEach(c => disruptedSet.add(c));
        if (data.stranded_list) data.stranded_list.forEach(c => strandedSet.add(c));
        currentAirportsGeo = data.airports_geo;
        currentRoutesGeo = data.routes_geo;
        communityCount = data.community_count || 0;
        updateGlobeLayers(); updateMetrics(data); updateLegend(); renderAirportList();
      } catch (e) { console.error(e); } 
      finally {
        document.getElementById('loading').classList.remove('active');
        document.getElementById('metrics').style.display = 'block';
      }
    };

    function updateMetrics(data) {
      const calc = (a, b) => b > 0 ? ((a - b) / b * 100).toFixed(1) + '%' : '0%';
      const { before, after } = data;
      document.getElementById('metrics').innerHTML = `
        <div class="metrics-grid">
          <div class="metric-card"><div class="metric-label">Nodes</div><div class="metric-value">${after.nodes}</div><div class="metric-change negative">${calc(after.nodes, before.nodes)}</div></div>
          <div class="metric-card"><div class="metric-label">Edges</div><div class="metric-value">${after.edges}</div><div class="metric-change negative">${calc(after.edges, before.edges)}</div></div>
          <div class="metric-card"><div class="metric-label">Efficiency</div><div class="metric-value">${after.efficiency.toFixed(4)}</div><div class="metric-change negative">${calc(after.efficiency, before.efficiency)}</div></div>
          <div class="metric-card"><div class="metric-label">Isolation</div><div class="metric-value">${strandedSet.size}</div><div class="metric-change negative">Airports</div></div>
        </div>`;
    }

    function renderAirportList() {
      const list = currentAirportsGeo.features.map(f => ({
        code: f.properties.code, name: f.properties.name, country: f.properties.country,
        disrupted: disruptedSet.has(f.properties.code), group: f.properties.group
      })).sort((a,b) => a.disrupted === b.disrupted ? a.code.localeCompare(b.code) : (a.disrupted ? -1 : 1));
      document.getElementById('airport-list').innerHTML = list.map(ap => `
        <div class="airport-item ${ap.disrupted ? 'disrupted' : ''}" onclick="toggleAirport('${ap.code}')">
          <div class="airport-code" style="color:${ap.disrupted ? COLORS.disrupted : getGroupColor(ap.group)}">${ap.code}</div>
          <div class="airport-details"><b>${ap.name}</b><br>${ap.country}</div>
          <div class="status-badge ${ap.disrupted ? 'disrupted' : 'active'}">${ap.disrupted ? 'Down' : 'Ok'}</div>
        </div>`).join('');
    }

    function updateLegend() {
      if (communityCount < 2) { document.getElementById('community-legend').style.display = 'none'; return; }
      let html = '';
      for(let i=0; i<Math.min(communityCount, 12); i++) 
        html += `<div class="legend-item"><div class="legend-color-box" style="background:${PALETTE[i]}"></div><span>Cluster ${i}</span></div>`;
      document.getElementById('legend-content').innerHTML = html;
      document.getElementById('community-legend').style.display = 'block';
    }

    document.getElementById('simulate').addEventListener('click', simulate);
    document.getElementById('reset').addEventListener('click', () => location.reload());
    updateGlobeLayers(); renderAirportList();
  </script>
  <script src="//unpkg.com/topojson-client"></script>
</body>
</html>