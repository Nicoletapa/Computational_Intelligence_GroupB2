<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flight Network Disruption Simulator 3D</title>
  <!-- Globe.gl Script -->
  <script src="//unpkg.com/globe.gl"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; overflow: hidden; background: #000; }
    
    #container { display: flex; height: 100vh; position: relative; }
    
    /* The 3D Canvas Container */
    #globe-viz { 
      flex: 1; 
      height: 100%; 
      background: #000011; /* Deep Space Blue/Black */
    }

    /* Sidebar Styles (Kept mostly same, adjusted for Dark Mode contrast) */
    #sidebar { width: 380px; background: #ffffff; color: #2c3e50; overflow-y: auto; z-index: 10; box-shadow: 4px 0 10px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
    #sidebar::-webkit-scrollbar { width: 8px; }
    #sidebar::-webkit-scrollbar-track { background: #f5f7fa; }
    #sidebar::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
    
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; color: white; }
    .header h1 { font-size: 24px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
    .section { padding: 20px 24px; border-bottom: 1px solid #e2e8f0; }
    .section h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; color: #667eea; }
    
    /* Controls */
    .control-group { margin-bottom: 16px; }
    .control-group label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 8px; color: #4a5568; }
    .input-row { display: flex; gap: 8px; align-items: center; }
    input[type="number"], select { flex: 1; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
    
    /* Buttons */
    .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; flex: 1; }
    .btn-secondary { background: #e2e8f0; color: #4a5568; flex: 1; }
    .button-row { display: flex; gap: 12px; }

    /* Metrics */
    .metrics-box { background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-top: 8px; }
    .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .metric-card { background: #ffffff; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; }
    .metric-label { font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 4px; }
    .metric-value { font-size: 20px; font-weight: 700; color: #667eea; }
    .metric-change.negative { color: #e53e3e; }

    /* Legend & List */
    .community-legend { background: rgba(255, 255, 255, 0.95); padding: 12px; border-radius: 8px; font-size: 11px; border: 1px solid #e2e8f0; margin-top: 8px; }
    .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .legend-color-box { width: 16px; height: 16px; border-radius: 3px; }
    
    #airport-list { max-height: 400px; overflow-y: auto; }
    .airport-item { padding: 12px; margin-bottom: 6px; background: #f7fafc; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .airport-item:hover { background: #edf2f7; transform: translateX(4px); }
    .airport-item.disrupted { background: #fff5f5; border: 1px solid #fc8181; }
    .airport-code { font-weight: 700; font-size: 14px; min-width: 40px; }
    .airport-details { flex: 1; font-size: 12px; }
    .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .status-badge.active { background: #c6f6d5; color: #22543d; }
    .status-badge.disrupted { background: #fed7d7; color: #742a2a; }

    .loading { display: none; text-align: center; padding: 20px; color: #667eea; }
    .loading.active { display: block; }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <div class="header">
        <h1><i class="fas fa-globe"></i> Global Disruption</h1>
        <p>3D Network Resilience Simulator</p>
      </div>

      <div class="section">
        <h3><i class="fas fa-sliders-h"></i> Controls</h3>
        <div class="control-group">
          <label>Auto-disrupt top airports</label>
          <div class="input-row">
            <input id="auto_n" type="number" value="0" min="0" max="50" placeholder="0">
            <select id="centrality">
              <option value="betweenness">Betweenness</option>
              <option value="degree">Degree</option>
              <option value="closeness">Closeness</option>
            </select>
          </div>
        </div>
        <div class="button-row">
          <button id="simulate" class="btn btn-primary"><i class="fas fa-play"></i> Simulate</button>
          <button id="reset" class="btn btn-secondary"><i class="fas fa-redo"></i> Reset</button>
        </div>
      </div>

      <div class="section">
        <h3><i class="fas fa-chart-line"></i> Metrics</h3>
        <div class="loading" id="loading">Analyzing...</div>
        <div class="metrics-box" id="metrics">
          <div style="text-align: center; color: #718096; padding: 20px;">Click <strong>Simulate</strong></div>
        </div>
        <div class="community-legend" id="community-legend" style="display: none;">
          <div id="legend-content"></div>
        </div>
      </div>

      <div class="section" style="flex: 1;">
        <h3><i class="fas fa-list"></i> Airports</h3>
        <div id="airport-list"></div>
      </div>
    </div>

    <!-- 3D Globe Container -->
    <div id="globe-viz"></div>
  </div>

  <script>
    // ========== CONFIG & CONSTANTS ==========
    const COLORS = {
      active: '#48bb78',
      disrupted: '#ef4444',      // Bright Red
      stranded: '#f97316',       // Bright Orange
      strandedAirport: '#fb923c'
    };

    // Community Palette (Neon / Space Theme)
    const PALETTE = [
      '#00ff00', '#ff00ff', '#00ffff', '#ffff00', 
      '#ff5555', '#5555ff', '#55ff55', '#ff55ff', 
      '#ffa500', '#ffc0cb', '#e6e6fa', '#008080'
    ];

    function getGroupColor(groupId) {
      if (groupId === -1) return '#ffffff'; // White for long haul
      return PALETTE[groupId % PALETTE.length];
    }

    // Load Initial Data
    const airportsGeo = {{ airports_json | safe }};
    const routesGeo = {{ routes_json | safe }};

    // State
    const disruptedSet = new Set();
    const strandedSet = new Set();
    let currentAirportsGeo = airportsGeo;
    let currentRoutesGeo = routesGeo;
    let communityCount = 0;
    let countriesData = [];

    // ========== 3D GLOBE INITIALIZATION ==========
    const globe = Globe()
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg') // Night view
      .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png') // 3D Terrain
      .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png') // Stars
      .width(document.getElementById('globe-viz').clientWidth)
      .height(window.innerHeight)
      // --- Points (Airports) ---
      .pointLat('lat')
      .pointLng('lng')
      .pointColor('color')
      .pointAltitude('altitude')
      .pointRadius('radius')
      .pointsMerge(true) // Performance optimization
      .onPointClick(d => toggleAirport(d.code)) // Interaction
      .pointLabel(d => `
        <div style="background: rgba(0,0,0,0.8); color: white; padding: 8px; border-radius: 4px; border: 1px solid ${d.color}">
          <b>${d.code}</b>: ${d.name}<br>
          ${d.city}, ${d.country}<br>
          ${d.status}
        </div>
      `)
      // --- Arcs (Routes) ---
      .arcStartLat('startLat')
      .arcStartLng('startLng')
      .arcEndLat('endLat')
      .arcEndLng('endLng')
      .arcColor('color')
      .arcDashLength('dash')    // Dashes for disrupted
      .arcDashGap('gap')        // Gaps for disrupted
      .arcDashAnimateTime('animate') // Animation speed
      .arcAltitude('arcAlt')    // Height of the flight path
      .arcStroke('stroke')      // Thickness
      // --- Polygons (Countries) ---
      .polygonSideColor(() => 'rgba(0,0,0,0)')
      .polygonStrokeColor(() => '#111')
      .polygonCapColor(d => d.color)
      .polygonAltitude(0.01)
      .onPolygonClick(d => toggleCountry(d.properties.name))
      .polygonLabel(d => `<div style="background:black; color:white; padding:4px;">${d.properties.name}</div>`)
      (document.getElementById('globe-viz'));

    // Auto-rotate slightly
    globe.controls().autoRotate = true;
    globe.controls().autoRotateSpeed = 0.5;

    // Handle Window Resize
    window.addEventListener('resize', () => {
      globe.width(document.getElementById('globe-viz').clientWidth);
      globe.height(window.innerHeight);
    });

    // ========== DATA CONVERSION (GeoJSON -> Globe Format) ==========
    function updateGlobeLayers() {
      
      // 1. PROCESS AIRPORTS
      const pointsData = currentAirportsGeo.features.map(f => {
        const p = f.properties;
        const g = f.geometry.coordinates;
        const code = p.code;
        
        let state = 'active';
        if (p.disrupted) state = 'disrupted';
        else if (strandedSet.has(code)) state = 'stranded';

        let color = getGroupColor(p.group);
        let radius = 0.2;
        let altitude = 0.01;

        if (state === 'disrupted') {
          color = COLORS.disrupted;
          radius = 0.4;
          altitude = 0.05; // Pop out disrupted airports
        } else if (state === 'stranded') {
          color = COLORS.strandedAirport;
          radius = 0.3;
        }

        return {
          code: code,
          name: p.name,
          city: p.city,
          country: p.country,
          lat: g[1],
          lng: g[0],
          color: color,
          radius: radius,
          altitude: altitude,
          status: state.toUpperCase(),
          group: p.group
        };
      });

      // 2. PROCESS ROUTES
      const arcsData = [];
      // Cache coordinates for speed
      const coordsMap = {};
      pointsData.forEach(p => coordsMap[p.code] = { lat: p.lat, lng: p.lng });

      currentRoutesGeo.features.forEach(f => {
        const p = f.properties;
        const src = coordsMap[p.src];
        const dst = coordsMap[p.dst];

        if (!src || !dst) return;

        const disrupted = p.disrupted;
        const isStranded = strandedSet.has(p.src) || strandedSet.has(p.dst);
        const groupId = p.group;

        let color, stroke, dash, gap, animate, arcAlt;

        if (disrupted) {
          // Disrupted: Red, flat against earth, dashed
          color = [COLORS.disrupted, COLORS.disrupted]; // Gradient start/end
          stroke = 0.5;
          dash = 1;
          gap = 2;
          animate = 0; // Static
          arcAlt = 0.02; // Very low
        } else if (isStranded) {
          // Stranded: Orange, medium height
          color = [COLORS.stranded, COLORS.stranded];
          stroke = 0.5;
          dash = null;
          gap = null;
          animate = 2000; // Slow movement
          arcAlt = 0.15;
        } else {
          // Active: Community Color, High Arc, Animated
          const c = getGroupColor(groupId);
          color = [c, c];
          
          if (groupId === -1) {
            // Inter-continental: Higher and thinner
            stroke = 0.3;
            arcAlt = 0.4; 
            animate = 1500;
            // Make transparent using RGBA
            color = [`rgba(255,255,255,0.3)`, `rgba(255,255,255,0.3)`]; 
          } else {
            stroke = 0.5;
            arcAlt = 0.2;
            animate = 1000; // Fast
          }
          dash = null; 
          gap = null; 
        }

        arcsData.push({
          startLat: src.lat,
          startLng: src.lng,
          endLat: dst.lat,
          endLng: dst.lng,
          color: color,
          stroke: stroke,
          dash: dash,
          gap: gap,
          animate: animate,
          arcAlt: arcAlt
        });
      });

      // 3. UPDATE GLOBE
      globe.pointsData(pointsData);
      globe.arcsData(arcsData);
      
      // Update Country Colors
      updateCountryColors();
    }

    // ========== LOGIC & INTERACTIONS ==========
    
    // Mapping logic
    const countryToAirports = {};
    airportsGeo.features.forEach(f => {
      const c = f.properties.country;
      if (!countryToAirports[c]) countryToAirports[c] = [];
      countryToAirports[c].push(f.properties.code);
    });

    // Load Country Borders
    fetch('//unpkg.com/world-atlas/countries-110m.json').then(res => res.json()).then(data => {
        countriesData = topojson.feature(data, data.objects.countries).features;
        globe.polygonsData(countriesData);
        updateCountryColors();
    });

    function updateCountryColors() {
      if (!countriesData.length) return;
      
      globe.polygonCapColor(d => {
        const cName = d.properties.name;
        let airports = countryToAirports[cName];
        
        // Fuzzy search for names (e.g. USA vs United States)
        if (!airports) {
           const key = Object.keys(countryToAirports).find(k => k.includes(cName) || cName.includes(k));
           if(key) airports = countryToAirports[key];
        }

        if (!airports) return 'rgba(0,0,0,0)'; // Transparent if no airports

        const disruptedCount = airports.filter(c => disruptedSet.has(c)).length;
        const total = airports.length;

        if (total > 0 && disruptedCount === total) return 'rgba(239, 68, 68, 0.6)'; // Red (Full disruption)
        if (disruptedCount > 0) return 'rgba(249, 115, 22, 0.4)'; // Orange (Partial)
        return 'rgba(255, 255, 255, 0.05)'; // Faint white (Active)
      });
      
      globe.polygonStrokeColor(() => 'rgba(255,255,255,0.1)');
    }

    function toggleCountry(cName) {
      let airports = countryToAirports[cName];
       if (!airports) {
           const key = Object.keys(countryToAirports).find(k => k.includes(cName) || cName.includes(k));
           if(key) airports = countryToAirports[key];
        }
      if(!airports) return;

      const all = airports.every(c => disruptedSet.has(c));
      airports.forEach(c => all ? disruptedSet.delete(c) : disruptedSet.add(c));
      
      updateGlobeLayers();
      renderAirportList();
    }

    function toggleAirport(code) {
      if (disruptedSet.has(code)) disruptedSet.delete(code);
      else disruptedSet.add(code);
      updateGlobeLayers();
      renderAirportList();
    }

    // ========== BACKEND COMMUNICATION ==========
    const simulate = async () => {
      const autoN = parseInt(document.getElementById('auto_n').value) || 0;
      document.getElementById('loading').classList.add('active');
      document.getElementById('metrics').style.display = 'none';

      try {
        const res = await fetch('/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            disrupted: Array.from(disruptedSet),
            auto_top_n: autoN,
            centrality_metric: document.getElementById('centrality').value
          })
        });

        const data = await res.json();
        
        disruptedSet.clear();
        strandedSet.clear();
        data.disrupted_list.forEach(c => disruptedSet.add(c));
        if (data.stranded_list) data.stranded_list.forEach(c => strandedSet.add(c));

        currentAirportsGeo = data.airports_geo;
        currentRoutesGeo = data.routes_geo;
        communityCount = data.community_count || 0;

        updateGlobeLayers();
        updateMetrics(data);
        updateLegend();
        renderAirportList();

      } catch (e) { console.error(e); } 
      finally {
        document.getElementById('loading').classList.remove('active');
        document.getElementById('metrics').style.display = 'block';
      }
    };

    function updateMetrics(data) {
      const calc = (a, b) => b > 0 ? ((a - b) / b * 100).toFixed(1) + '%' : '0%';
      const { before, after } = data;
      
      document.getElementById('metrics').innerHTML = `
        <div class="metrics-grid">
          <div class="metric-card"><div class="metric-label">Nodes</div><div class="metric-value">${after.nodes}</div><div class="metric-change negative">${calc(after.nodes, before.nodes)}</div></div>
          <div class="metric-card"><div class="metric-label">Edges</div><div class="metric-value">${after.edges}</div><div class="metric-change negative">${calc(after.edges, before.edges)}</div></div>
          <div class="metric-card"><div class="metric-label">Efficiency</div><div class="metric-value">${after.efficiency.toFixed(4)}</div><div class="metric-change negative">${calc(after.efficiency, before.efficiency)}</div></div>
          <div class="metric-card"><div class="metric-label">Isolation</div><div class="metric-value">${strandedSet.size}</div><div class="metric-change negative">Airports</div></div>
        </div>`;
    }

    function renderAirportList() {
      const list = currentAirportsGeo.features.map(f => ({
        code: f.properties.code,
        name: f.properties.name,
        country: f.properties.country,
        disrupted: disruptedSet.has(f.properties.code),
        group: f.properties.group
      })).sort((a,b) => a.disrupted === b.disrupted ? a.code.localeCompare(b.code) : (a.disrupted ? -1 : 1));

      document.getElementById('airport-list').innerHTML = list.map(ap => `
        <div class="airport-item ${ap.disrupted ? 'disrupted' : ''}" onclick="toggleAirport('${ap.code}')">
          <div class="airport-code" style="color:${ap.disrupted ? COLORS.disrupted : getGroupColor(ap.group)}">${ap.code}</div>
          <div class="airport-details"><b>${ap.name}</b><br>${ap.country}</div>
          <div class="status-badge ${ap.disrupted ? 'disrupted' : 'active'}">${ap.disrupted ? 'Down' : 'Ok'}</div>
        </div>
      `).join('');
    }

    function updateLegend() {
      if (communityCount < 2) { document.getElementById('community-legend').style.display = 'none'; return; }
      let html = '';
      for(let i=0; i<Math.min(communityCount, 12); i++) {
        html += `<div class="legend-item"><div class="legend-color-box" style="background:${PALETTE[i]}"></div><span>Cluster ${i}</span></div>`;
      }
      document.getElementById('legend-content').innerHTML = html;
      document.getElementById('community-legend').style.display = 'block';
    }

    // Events
    document.getElementById('simulate').addEventListener('click', simulate);
    document.getElementById('reset').addEventListener('click', () => location.reload());

    // Initial Load
    updateGlobeLayers();
    renderAirportList();
  </script>
  <!-- Helper for Topology conversion -->
  <script src="//unpkg.com/topojson-client"></script>
</body>
</html>